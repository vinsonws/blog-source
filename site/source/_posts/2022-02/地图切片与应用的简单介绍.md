---
title: "[GIS] 地图切片与应用的简单介绍"
seo_title: "[GIS] 地图切片与应用的简单介绍"
indent: true
comments: true
cover: false
mathjax: false
pin: false
author: vinsonws
top_meta: true
bottom_meta: true
icons:
  - fas fa-fire red
  - fas fa-star green
plugins:
  - indent
date: 2023-02-22 15:19:56
updated: 2023-02-22 15:19:56
tag:
categories:
keywords:
description:
references:
  - title: Tiled web map
    url: https://en.wikipedia.org/wiki/Tiled_web_map
  - title: Tile Map Service Specification
    url: https://wiki.osgeo.org/wiki/Tile_Map_Service_Specification
  - title: OpenGIS Web Map Tile Service Implementation Standard
    url: https://www.ogc.org/standard/wmts/
  - title: Bing Maps Tile System
    url: https://learn.microsoft.com/en-us/bingmaps/articles/bing-maps-tile-system?redirectedfrom=MSDN
  - title: Quadtree
    url: https://en.wikipedia.org/wiki/Quadtree
---
近年来，越来越多地图应用在浏览器端展示，如谷歌地图、OpenStreetMap、百度地图等国内外知名的地图服务商都是以浏览器展示为主要应用。浏览器展示地图非常方便，不需要单独下载一个软件来作为地图的展示工具。但是在浏览器端有着性能、带宽等诸多限制，本文来简单介绍下栅格、矢量甚至地形切片的原理，以及一些成熟的工具的应用。
<!-- more -->

## 什么是切片（tile）？

2005年Google地图首先采用Web墨卡托投影，此投影不是公认的大地测量系统，使用球形显影椭球坐标系。相对于 WGS 84/World Mercator (CRS code 3395) ，在地图上(地面上21公里) ，比例尺误差为0.7% ，北方误差高达43公里。Web墨卡托投影的非官方EPSG编码为900913，后来EPSG官方给它3857这个正式编码。Google地图在空间坐标系为EPSG:3857的基础上，推出了Tiled web map（OpenStreetMap的专业术语为slippy map），这就是今天WEB地图切片的雏形。

### Google地图切片的惯例

* 瓦片为256x256像素
* 在最上层的缩放级别为0，此时展示整个世界
* 每增加一个缩放层级，长和宽两个维度的切片数量都增加一倍
* 空间参考系为WEB墨卡托，维度在 85.06°S 到 85.06°N

### OpenStreetMap的标准--Slippy Map Tilenames（也叫XYZ）

> XYZ标准遵循Google地图切片的惯例，也增加了一些内容：

* 每个层级切片有一个x和一个y编号
* PNG格式的瓦片图像
* 图片是通过WEB服务器提供的，url类似于 http://.../z/x/y.png ，其中z是缩放级别，x和y标识瓦片

### “切片”的意义

所有使用切片的地图服务一般来说，主要目的有两点：

{% folding ::1. 切片地图可以给使用者一种正在查看整张地图的错觉%}

OpenStreetMap将其命名为Slippy Map（滑动地图），就是根据这个特性。传统的oms和wms协议，返回的是某个区域的的地图，每次移动都会是地图重新加载；而切片地图，则是以瓦片的形式展示，瓦片的排列方式是固定的，滚动地图时只会加载不存在的部分，不会使整个地图刷新。

{% endfolding %}

{% folding ::2. 切片地图可以提升性能%}

由于切片索引对应的坐标的唯一性，切片完全可以提前做，在加载的时候只需要访问切好的目录，实际性能表现应该比oms和wms这种处理原图方式性能更好

{% endfolding %}

## 目前常用的WEB地图切片标准

当前比较常用的WEB地图切片，分别有三个Tile Map Service（TMS）、Web Map Tile Service（WMTS）和 Bing Maps Tile System。其中 Bing Maps Tile System 的涉及较少，只有 Bing Maps 在用，它的原理是 [Quadtree](https://en.wikipedia.org/wiki/Quadtree)，本人了解有限这里不再展开篇幅介绍。接下里重点介绍Tile Map Service 和 Web Map Tile Service。

### Tile Map Service（TMS）

Tile Map Service（下文称TMS）是 OSGeo 提出并且维护的标准，但这是一个社区标准，它未被 OSGeo 认可为基金会的官方项目或工作产品。在其 OSGeo 的[TMS规范的官方文档](https://wiki.osgeo.org/wiki/Tile_Map_Service_Specification)中，详细描述了TMS的url规则、返回值一级一些异常处理情况。总结如下：

1. TMS的URL格式为 http://tms.osgeo.org/1.0.0/{name}/{z}/{x}/{y}.{format}
2. TMS作为资源部署到WEB服务器，接口需要返回资源描述（text/xml）
3. TMS的每个瓦片像素大小一般为 256x256，所有层级瓦片大小一致，且都为正方形
4. TMS有四个Profiles：
   1. none：表示没有资源
   2. global-geodetic：
      1. srs 必须为 EPSG:4326
      2. 像素满足公式 $units-per-pixel = 0.703125 / 2^n$
   3. global-mercator
      1. srs 必须为 OSGEO:41001
      2. 像素满足公式 $units-per-pixel = 78271.516 / 2^n$
   4. local
      1. 可以使用任何坐标系
      2. 像素满足公式 $units-per-pixel = 2^n$
5. TMS可以用多种文件格式（jpg、png等），在TileFormat中展示
6. TMS以左下角为原点x的序号从左到右，y的序号从下到上

{% image /img/post/2023-02/Tms-tiles.png::alt=TMS以左下角为原点 %}

### Web Map Tile Service（WMTS）

Web Map Tile Service（下文称WMTS）是ogc提出的标准，这是一个ogc的官方标准，在[官方界面](https://www.ogc.org/standard/wmts/)上，ogc提供了WMTS的规范pdf下载，此pdf有100多页3万多个单词，如果读者感兴趣，可以去研究一下，这里简单的总结了下：

1. WMTS受TMS的启发，在TMS之后实现的（WMTS在2010年左右提出）
2. WMTS可提供三种数据：
   1. ServiceMetadata：服务的元数据它描述了特定服务器实现的能力和信息持有量。GetCapabilities 操作获取。
   2. Tile：切片数据，GetTile 操作获取
   3. FeatureInfo：其他数据，提供有关位于瓦片地图特定像素的要素的信息，GetFeatureInfo 操作获取
3. WMTS可以在不同层级下提供不同大小的瓦片，不同层级的瓦片大小可以不同，所有瓦片为矩形
4. WMTS可以用多种格式
5. WMTS以左上角为原点x的序号从左到右，y的序号从上到下
6. WMTS支持 KVP、SOAP、RESTful

{% image /img/post/2023-02/wmts-tile.png::alt=WMTS以左上角为原点 %}

### TMS vs. WMTS

{% folding cyan open::TMS和WMTS的不同点 %}

{% note paperclip ::TMS的原点在左下角；WMTS的原点在左上角 %}
{% note paperclip  cyan::TMS返回的主要数据切片的数据；WMTS可以返回除切片外的其他数据 %}
{% note paperclip  blue::TMS的切片必须是正方形并且所有层级的切片大小一样；WMTS的切片形状满足矩形，不同层级的切片大小不一样 %}
{% note paperclip  gray::TMS只支持web服务器提供切片；WMTS支持KVP、SOAP以及RESTful %}

{% endfolding %}

{% folding cyan open::总结：TMS规范了XYZ的标准，WMTS在TMS基础上扩展了更多功能。由于TMS更简单，个人认为大多数场景下TMS就够了。 %}

目前来看最受欢迎的是XYZ标准，或者说未完全实现的TMS规范。大多数人只需要一个XYZ标准的url其他根据默认的配置就能够展示地图，所以很多服务并没有完全实现TMS（但是他们还是称自己的服务为TMS，据说他们觉得GSGeo的规范太复杂了）。而WMTS功能非常强大，但是它太复杂了，WMTS规范正文60多页，加上对象定义等一些必要内容，总页数达到了100多页，非常复杂。许多GIS服务提供商连规范字数少很多的TMS（可能字数只有WMTS文档的5分之一）都没有完全实现，更别说WMTS了。而且以WMTS的规范内容来看，就有一种SOA时代的气息。我更看好TMS.

{% endfolding %}

## 切片格式

### 栅格

### 矢量

### 地形

## 切片程序

### GeoWebCache

### NextGisWeb

### geo_tiler.py

## 总结